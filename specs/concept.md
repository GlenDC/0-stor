# Single Disk Stor (SDStor)

### Concept:
- services objects over network from a chosen data structure e.g. SophiaDB...
- is backend object stor which can be used by high level client for storing files, directories, ...

### Format of objects stored on disk
Structure used:
```
- 1 byte : Number of references stored, 0 means is deleted, 255 means permanent
- 160 * 16 bytes (2,56KB): **FIXME: why need this if we have the refernce counter already ? **
    list of consumers
    each consumer is represented with a 16 bytes id
- 4 bytes: CRC of payload behind
- payload: actual data, max size 1M
```

- consumer is ItsYou.online UID
- special first byte meaning:
	- 0: no consumers, marked for deletion but is still there
	- 255: permanent = cannot be deleted

### principles

- rest based network server (using go-raml to generate)
- backend is ardb with selected data store. **Still need to make some perf test to see which one will give more thoughput.**
 We will start with forestdb
- when HD then there is maximum one NOS per HD, on SSD preferably as well but can change

#### Data Format send from the client:
Before sending any data to the client, the data need to be process using the follow flow:

1. Split data into blocks of `blocksize` (configurable)
2. for each block:
 - create hash of the block (h1)
 - compress the block using snappy
 - symetric encryption of block using h1 as key
 - hash compressed/encrypted block (h2)
 - create crc of the compressed/encrypted block
3. Uploads all the blocks:
    - h1 is the key of the block
    - compressed/encrypted block+crc is the playload


### 3 types of secrets

- admin Secret
	- administrator of the sdstor, is set during install
	- can be changed by the administrator itself
- reservation token
	- created during the reservation creation. Is needed to manage the reservation
- data access token
	- can be generated by setting ACL for a certain user. This token is needed to create/access the data. The token describe what action can be done. (Read, Write, Delete)
    Multiple data access token can be created.   
    They are shot living to allow quick access revocation

### API

- [Raml specification](raml/sdstor.raml)
- [HTML rendered](https://rawgit.com/g8os/sdstor/master/specs/raml/sdstor.html)

### tracking of usage

Per reservation track:
- nr of requests per hour
- nr of objects stored
- size of the data

### questions/assumptions:
- We use only access data token to control access. Any user if he knows proper token, he can access data.
- ~~If access set for "" (empty) dataSecret it means reservation is open for anyone.~~ do we still want this feature?
- We use ItsYou.online IDs to identify consumers.
- Data structure contains MD5 hashes of ItsYou.online IDs.
- On put if we put new data content with the same key, data gets rewrited but consumer list remains the same.
