# Single Disk Stor (SDStor)

### Concept:
- services objects over network from a chosen data structure
- is backend object stor which can be used by high level client for storing files, directories, ...

### Format of objects stored on disk
Structure used:
```
- 1 byte : Number of references stored, 0 means is deleted, 255 means permanent
- 160 * 16 bytes (2,56KB): list of consumers
    each consumer is represented with a 16 bytes id
- 4 bytes: CRC of payload behind
- payload: actual data, max size 1M
```

- consumer is a 16 byte string (this has no meaning for the 0-stor, its up to the user to give meaning to it e.g. IYO uid)
- special first byte meaning:
	- 0: no consumers, marked for deletion but is still there
	- 255: permanent = cannot be deleted

### principles

- rest based network server (using go-raml to generate)
- backend is [badger](https://github.com/dgraph-io/badger)
- key and value can be written on two different location which enable use to put keys on a fast disk (ssd) and value on a slower disk. Since value log is always append, we don't loose too much performance even if we write in HDD
- we don't work with reference counter only, we need to keep list of consumers (reference counter to dangerous)

#### Data Format send from the client:
Before sending any data to the client, the data need to be process using the follow flow:

1. Split data into blocks of `blocksize` (configurable)
2. for each block:
 - create hash of the block (h1)
 - compress the block using snappy
 - symetric encryption of block using h1 as key
 - hash compressed/encrypted block (h2)
 - create crc of the compressed/encrypted block
3. Uploads all the blocks:
    - h1 is the key of the block
    - compressed/encrypted block+crc is the playload


### 3 types of secrets

- admin Secret
	- administrator of the sdstor, is set during install
	- can be changed by the administrator itself
- reservation token
	- created during the reservation creation. Is needed to manage the reservation
- data access token
	- can be generated by setting ACL for a certain user. This token is needed to create/access the data. The token describe what action can be done. (Read, Write, Delete)
    Multiple data access token can be created.
    They are shot living to allow quick access revocation

### API

- [Raml specification](raml/sdstor.raml)
- [HTML rendered](https://htmlpreviewer.github.io/?./raml/sdstor.html)

### tracking of usage

Per reservation track:
- nr of requests per hour
- nr of objects stored
- size of the data

### remarks
- We use only access data token to control access. Any user if he knows proper token, he can access data.
- We cannot overwrite data !!! once written it can only be deleted, once deleted a new one can be created.
